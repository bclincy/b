version: '3.7'

services:
  back_end: # actual backend server
    build:
      context: ./backend
      dockerfile: ./Dockerfile-apiserver
    container_name: php_backend
    restart: always
    volumes:
      - ./backend/code:/usr/share/nginx/html # copy php code to the nginx server
      - ./backend/nginx/ssl/:/etc/ssl
      - ./backend/nginx/default.template.conf:/etc/nginx/conf.d/default.template # template conf to copy from
      - ./backend/nginx/logs:/var/log/nginx
    ports:
      - 8000:80
      - 3000:443
    env_file:
      - ./backend/code/.env
    command: /bin/sh -c "envsubst '$$NGINX_HOST' < /etc/nginx/conf.d/default.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"
    depends_on:
      - php_backend_fpm
      - mysqldb
  php_backend_fpm: # strictly used for debugging php
    build:
      context: ./backend
      dockerfile: ./Dockerfile-fpmserver
    container_name: php_backend_fpm
    restart: always
    ports:
      - 9001:9000
    volumes:
      - ./backend/code:/var/www/html
      - ./backend/code/.env:/var/www/html/.env # we should separate the values in this file from the actual app in production...
    #    command: ["composer", "install"]
    tty: true
    env_file:
      - backend/code/.env
  front_end:
    build: ./frontend/
    ports:
      - 88:2424
    #      - 2424:2424
    env_file:
      - ./frontend/.env
  myadmin:
    image: phpmyadmin/phpmyadmin
    container_name: phpmyadmin
    ports:
      - "8080:80"
    environment:
      - PMA_ARBITRARY=1
      - PMA_HOST=${MYSQL_HOST}
    restart: always
    depends_on:
      - mysqldb
  mysqldb:
    build: ./mysqldb/
    container_name: mysqldb
    restart: always
    env_file:
      - ./mysqldb/.env
    environment:
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    ports:
      - 3307:3306 # exposes 3307 for debug purposes. DO NOT USE IN PRODUCTION
    #      - 3306
    command: --default-authentication-plugin=mysql_native_password
    volumes:
      - ./mysqldb/persistance:/var/lib/mysql
      - ./mysqldb/init.sql:/docker-entrypoint-initdb.d # sql file for loading initial data
volumes:
  persistent_data: